<script>
    let max = 39;
    let done = 0;

    async function mergeFiles(fileParts) {
        const downloadPromises = fileParts.map((url, index) => 
            fetch(url, { mode: 'cors' }).then(res => res.arrayBuffer())
            .then(data => {
                done++;
                document.querySelector("#loading-text").textContent = `FAST LOADING... (${done}/${max})`;
                return { index, data };
            })
        );

        const results = await Promise.all(downloadPromises);
        results.sort((a, b) => a.index - b.index);
        // We specify the type here to help Unity recognize the data
        return URL.createObjectURL(new Blob(results.map(r => r.data), { type: 'application/octet-stream' }));
    }

    function getParts(file, start, end) {
        let parts = [];
        for (let i = start; i <= end; i++) { parts.push(file + ".part" + i); }
        return parts;
    }

    Promise.all([
        mergeFiles(getParts("Build/FTFHAPort.data.unityweb", 1, 39)),
    ]).then(([dataUrl]) => {
        var json = {
            companyName: "Rayll",
            productName: "Fears To Fathom",
            dataUrl: dataUrl,
            wasmCodeUrl: "FTFHAPort.wasm.code.unityweb",
            wasmFrameworkUrl: "FTFHAPort.wasm.framework.unityweb",
            TOTAL_MEMORY: 536870912,
            graphicsAPI: ["WebGL 2.0", "WebGL 1.0"],
            webglContextAttributes: { preserveDrawingBuffer: false },
            splashScreenStyle: "Dark",
            backgroundColor: "#231F20",
        };

        // Added a tiny timeout to prevent the 'Script Error' during initialization
        setTimeout(() => {
            UnityLoader.instantiate("unityContainer", json, {
                Module: {
                    onRuntimeInitialized: function () {
                        document.querySelector("#loading-text").remove();
                    },
                    // This helps catch the specific error in the console
                    onError: function(err) { console.error(err); }
                },
            });
        }, 100);
    });
</script>
